<html>
 	<head />
	<body style="background:url('images/blocks/blockA.png')">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
		<script type="application/javascript">
	    	$(document).ready(function() {
	    		window.scrollTo(0, 0);
	    		
				$('#enter').click(function(e) {
					init(e, false);
				});
				
				$('#random').click(function(e) {
					init(e, true);
				});
		    });
	    	
	    	function init(e, jump) {
	    		e.preventDefault();
				
	    		loginName = $('#loginName').val();
				if (loginName.length != 0) {
					$('#login').remove();
					
					canvas = $('#canvas').get(0);
					ctx = canvas.getContext('2d');
					ctx.globalAlpha = 1;
					
					$('#mana1').show();
					$('#mana2').show();
					$('#mana3').show();
					
					engineFramesPerSecond = 48;
					refreshRate = 1000 / engineFramesPerSecond;
					inactivityTimeout = 3000;
					timedOut = false;
					timedOutCount = 0;
					totalReqCount = 0;
					needsRefresh = false;
					
					refresh(true, jump);
	    		}
	    	}
	    	
	    	function refresh(init, jump) {
	    		if (init) {
	    			images = new Array();
		    		keydowns = new Array();
					keyups = new Array();
					
					inactivityCount = 0;
					text = "";
					cellText = "";
				}
	    		
	    		$.post(
	    			'/Cellwarz/refresh',
	    			{login: loginName, jump: jump},	
	    			function(data) {
						sprites = data.sprites;
						
						if (init) {
							avatars = data.avatars;
							tools = data.tools;
							
							imagePaths = data.imagePaths;
							for (var i = 0; i < imagePaths.length; i++) {	
								image = new Image();
								image.src = imagePaths[i];
								images[i] = image;
							}
							
							needsRefresh = false;
							sync();
						}
					}).fail(function() {
						refresh(init, jump);
	    			});
	    	}
	    	
	    	function sync() {
	    		setTimeout("poll()", refreshRate);
	    	}
	    	
	    	function poll() {
	    		if (inactivityCount < inactivityTimeout) {
		    		if (timedOut) {
		    			for (i = 0; i < keydowns.length; i++) {
		    				keyups[keyups.length] = keydowns[i];
		    			}
		    		}
		    		
		    		if (totalReqCount % (engineFramesPerSecond * 3) == 0) {
		    			refresh(false, false);
		    		}
		    		
		    		if (needsRefresh) {
    					refresh(true, false);
    					return;
		    		}
		    		
	    			$.ajax({
		    			type: 'POST',
		    			url: '/Cellwarz/sync',
		    			data: {login: loginName, keydowns: JSON.stringify(keydowns), keyups: JSON.stringify(keyups)},
		    			success: function(data) {
		    				ctx.fillStyle = "lightblue";
		    				ctx.fillRect(0, 0, canvas.width, canvas.height);
		    				
		    				spriteIds = Object.keys(data);
		    				if (spriteIds.length == 0) {
		    					needsRefresh = true;
		    					sync();
		    					return;
		    				} 
		    				
							for (i = 0; i < spriteIds.length; i++) {
								if (spriteIds[i] == "message") {
									cellText = data["message"];
								} else {
									spriteId = spriteIds[i];
									newSprite = data[spriteId];
									
									if (newSprite[0] == "-1") {
										if (sprites[spriteId]) {
											delete sprites[spriteId];
										}
									} else {
										sprites[spriteId] = [newSprite[0], newSprite[1], newSprite[2]];
										
										extraInfo = newSprite[3];
										if (extraInfo) {
											avatarName = extraInfo["0"];
											if (avatarName) {
												avatars[avatarName] = spriteId;
											}
											
											newTools = extraInfo["1"];
											if (newTools) {
												if (newTools["-1"]) {
													$('#mana1').css('background-image', 'none');
												} else {
													tools = newTools;
												}
											}
										}
									}
								}
							}
							
							spriteIds = Object.keys(sprites);
							for (i = 0; i < spriteIds.length; i++) {
								sprite = sprites[spriteIds[i]];
								if (sprite[0] != -1) {
									ctx.drawImage(images[sprite[0]], sprite[1], sprite[2]);
								}
							}

							ctx.fillStyle = "red";
							ctx.font = "bold 16px Arial";
							
							//if (totalReqCount % 5 == 0) {
							//	text = "Fail Rate: " + (timedOutCount * 100 / totalReqCount) + "%";
								
								//"InactivityCount: " + inactivityCount;
		    				//}

							ctx.fillText(loginName + ": " + text, 98, 98);
							
							ctx.fillStyle = "darkred";
							ctx.fillText(cellText, 98, 148);
							
							avatarNames = Object.keys(avatars);
							for (i = 0; i < avatarNames.length; i++) {
								name = avatarNames[i];
								sprite = sprites[avatars[name]];
								
								if (sprite) {
									ctx.fillText(name, sprite[1] - 8, sprite[2] - 16);
								} else {
									delete avatars[name];
								}
							}
							
							if (Object.keys(tools).length != 0) {
								$('#mana1').css('background-image', 'url(\'' + imagePaths[tools[0]] + '\')');
								delete tools[0];
							}
							
							timedOut = false;
							sync();
		    			}, timeout: 100}) //This has to be a balance between requests that stall and requests that take too long ...
					.fail(function() {
						sync();
	    				timedOut = true;
	    				timedOutCount++;
	    			});
		    		
		    		inactivityCount++;
		    		totalReqCount++;
		    		
		    		
		    		if (totalReqCount % 18 == 0) {
	    				me = sprites[avatars[loginName]];
	    				if (me) {
							window.scrollTo(me[1] - 576, me[2] - 448);
	    				}
		    		}
		    		
		    		if (totalReqCount % 250 == 0) {
		    			totalReqCount = 0;
		    			timedOutCount = 0;
		    		}
		    		
		    		if (keydowns.length != 0) {
		    			keydowns = new Array();
		    			inactivityCount = 0;
		    		}
		    		
		    		if (keyups.length != 0) {
		    			keyups = new Array();
		    			inactivityCount = 0;
		    		}
	    		} else if (inactivityCount == inactivityTimeout) {
	    			ctx.fillStyle = "gray";
	    			ctx.fillRect(0, 0, 1152, 896);
	    			
	    			spriteIds = Object.keys(sprites);
	    			for (i = 0; i < spriteIds.length; i++) {
						sprite = sprites[spriteIds[i]];
						ctx.drawImage(images[sprite[0]], sprite[1], sprite[2]);
					}
	    			
	    			inactivityCount++;
	    			sync();
	    		} else if (keydowns.length != 0 || keyups.length != 0) {
	    			refresh(true, false);
	    		} else {
	    			sync();
	    		}
	    	}
		    
		    $(document).keydown(function(event) {
		    	if (event.keyCode == 37 || event.keyCode == 38 || event.keyCode == 39 || event.keyCode == 40) {
		    		event.preventDefault();
		    	} else if (event.keyCode == 32 || (event.keyCode > 57 && event.keyCode < 91)) { //letters
		    		text = text + String.fromCharCode(event.keyCode); 
		    	} else if (event.keyCode == 8) { //backspace
		    		var input = event.srcElement || event.target;
		            if ((input.tagName.toUpperCase() === 'INPUT' && (input.type.toUpperCase() === 'TEXT' || input.type.toUpperCase() === 'PASSWORD')) 
		                || input.tagName.toUpperCase() === 'TEXTAREA') {
		                
		            	if (input.readOnly || input.disabled) {
		                	event.preventDefault();
		                }
		            }
		            else {
		            	event.preventDefault();
		            }
		    		
		    		if (text.length > 0) {
		    			text = text.substring(0, text.length - 1);
		    		}
		    	} else if (event.keyCode == 13) {
		    		if (text.length > 0) {
		    			$.post('/Cellwarz/message', {login: loginName, message: text});
		    			text = "";
		    		}
		    	}
		    	
		    	keydowns[keydowns.length] = event.keyCode;
			});
			
			$(document).keyup(function(event) {
				keyups[keyups.length] = event.keyCode;
			});
			
			//canvas.onclick=function(event) {
			   	//cell.click(event.clientX - 48, event.clientY - 48); //window x and y value (not canvas x and y)
			//};
  		</script>
  		<table>
  			<tr style="height: 48px" />
  			<tr>
  				<td style="width: 48px" />
  				<td>
  					<canvas id="canvas" width="1152" height="896" style="margin-top: -13; margin-left: -15"></canvas>
  				</td>
  			</tr>
  		</table>
  		<div id="login" style="background-color:lightblue; height:640px; left:48px; position:absolute; top:48px; width:528px">
  			<div style="margin-left:40px; margin-top:20px; margin-bottom:-10px">
  				<form>
					Login: <input id="loginName" type="text">
					<input id="enter" type="submit" value="Reattach!">
					<input id="random" type="submit" value="Enter randomly!">
				</form> 
  			</div>
  			<p style="padding: 20px">
	  			Welcome to Cell Warz! You are about to enter a multi-player, interactively creative, yet competitively destructive
	  			world with nothing but your ninja avatar. But fear not, by weilding the powers of the cell blocks, you can
	  			achieve great things!
	  			<br><br>
	  			Instructions:
	  			<br>
	  			You can enter the world in one of two ways: either by re-attaching to an existing avatar or by entering one of the
	  			random rooms. Once in a room you can travel to other rooms by entering a doorway portal. Tell your buddies/enemies
	  			to enter the world while you play for a fully interactive online multi-player experience (whether you fight or
	  			befriend other players is up to you). Be careful because you can be killed in this world, in which case you will
	  			have to re-enter as before (but perhaps your cell blocks might not be safe unless you are there). You can chat
	  			with other players if you wish at any time in the cell room but please keep profanity to a minimum.
	  			<br>
	  			<br>
	  			The cell blocks which you will encounter in this world can be activated when you are standing on them, in which
	  			case you will see "dashboard" icons appear in the top right corner. These will indicate which number keys you
	  			can press to use the cell block powers/weapons. 
	  			
	  			<br><br>
	  			Keys:
	  			<br>
	  			Up: jump
	  			<br>
	  			Left/Right: run
	  			<br>
	  			Down: activate/deactivate cell block
	  			<br>
	  			Spacebar: pick up or drop a cell block
	  			<br>
	  			Letters: you can prepare a chat message in the window
	  			<br>
	  			Enter: post the message in the current cell room
  			</p>
  	
  		</div>
  		<div id="mana1" style="display: none; height:96px; left:90%; position:fixed; top:10px; width:96px" >
  		</div>
  		<div id="mana2" style="display: none; height:96px; left:90%; position:fixed; top:70px; width:96px" >
  		</div>
  		<div id="mana3" style="display: none; height:96px; left:90%; position:fixed; top:130px; width:96px" >
  		</div>
	</body>
</html>